name: Build

on: [push]

jobs:
  build_win:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          toolset: 14.0
          sdk: 10.0.17763.0


      - name: Cache LuaVM
        id: cache-luavm
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\LUAVM
          key: ${{ runner.os }}-luavm-
          restore-keys: |
            ${{ runner.os }}-luavm-

      - name: Install LuaVM
        if: steps.cache-luavm.outputs.cache-hit != 'true'
        run: |
          $ErrorActionPreference = "Stop"
          
          Invoke-WebRequest -OutFile LuaVM-0.5.4-vs2015-x64.exe https://github.com/xpol/luavm/releases/download/0.5.4/LuaVM-0.5.4-vs2015-x64.exe
          echo "Installing LuaVM"
          Start-Process .\LuaVM-0.5.4-vs2015-x64.exe -argumentlist "/verysilent" -Wait 
          echo "Install Finished"


      - name: Setup LuaVM    
        run: |
          $env:Path += ";" + $env:LOCALAPPDATA + "\LuaVM;" + $env:LOCALAPPDATA + "\LuaVM\externals\bin;" + $env:LOCALAPPDATA + "\LuaVM\versions\5.3" 
          luavm use 5.3 
          lua -v
          echo $env:LOCALAPPDATA"\LuaVM;"$env:LOCALAPPDATA"\LuaVM\externals\bin;"$env:LOCALAPPDATA"\LuaVM\versions\5.3" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append


      - name: Copy Libs
        run: |
          $ErrorActionPreference = "Stop" 

          Copy-Item externals/bin/* -Destination $env:LOCALAPPDATA"\LuaVM\externals\bin" -Recurse -Force
          Copy-Item externals/lib/* -Destination $env:LOCALAPPDATA"\LuaVM\externals\lib" -Recurse -Force
          Copy-Item externals/include/* -Destination $env:LOCALAPPDATA"\LuaVM\externals\include" -Recurse -Force

      # - name: Build lanes
      #   run: |
      #     luarocks install lanes

      # - name: Setup Sccache
      #   run: |
      #     scoop install sccache

      - name: Cache wxwidgets
        id: cache-wxwidgets
        uses: actions/cache@v3
        with:
          path: wxWidgets
          key: ${{ runner.os }}-wxwidgets-
          restore-keys: |
            ${{ runner.os }}-wxwidgets-

      - name: Build wxWidgets
        if: steps.cache-wxwidgets.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -OutFile wxWidgets-3.1.6.zip https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.6/wxWidgets-3.1.6.zip
          7z x -owxWidgets wxWidgets-3.1.6.zip
          cd wxWidgets\build\msw\
          nmake -f makefile.vc SHARED=0 UNICODE=1 BUILD=release TARGET_CPU=AMD64

      - name: Cache wxlua
        id: cache-wxlua
        uses: actions/cache@v3
        with:
          path: wxlua
          key: ${{ runner.os }}-wxlua-
          restore-keys: |
            ${{ runner.os }}-wxlua-


      - name: Build wxlua
        if: steps.cache-wxlua.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/pkulchenko/wxlua
          patch wxlua/wxlua/modules/luamodule/luamodule.cpp patches/wxlua.patch --binary
          mkdir wxlua/wxlua/wxlua-build
          pushd .
          cd wxlua/wxlua/wxlua-build
          cmake .. -DCMAKE_BUILD_TYPE=Release  -DwxWidgets_ROOT_DIR="$env:GITHUB_WORKSPACE"/wxWidgets/ -DwxLua_LUA_LIBRARY_USE_BUILTIN=false -DwxLua_LUA_INCLUDE_DIR="$env:LOCALAPPDATA"\LUAVM\versions\5.3\include -DwxLua_LUA_LIBRARY="$env:LOCALAPPDATA"\LUAVM\versions\5.3\lua53.lib
          cmake --build . --config Release
          popd



      - name: Copy wxLua   
        run: |
          cp wxlua/wxlua/wxlua-build/bin/Release/wx.dll $env:LOCALAPPDATA"\LuaVM\versions\5.3\cmod"
          mkdir tests/wxlua
          mkdir docs/wxlua
          cp -r wxlua/wxlua/samples/* tests/wxlua
          cp -r wxlua/wxlua/docs/* docs/wxlua

      - name: Build LuaSocket
        run: |
          luarocks unpack luasocket
          pushd .
          cd luasocket-3.0.0-1/luasocket
          luarocks make luasocket-3.0.0-1.rockspec
          popd
          mkdir docs/luasocket
          cp -r luasocket-3.0.0-1/luasocket/docs/* docs/luasocket
          cp -r luasocket-3.0.0-1/luasocket/README.md docs/luasocket
          cp -r luasocket-3.0.0-1/luasocket/LICENSE docs/luasocket

      - name: Build timerwheel
        run: |
          luarocks unpack timerwheel
          pushd .
          cd timerwheel-0.2.0-2/timerwheel.lua/
          luarocks make timerwheel-0.2.0-2.rockspec
          popd
          mkdir docs/timerwheel
          cp -r timerwheel-0.2.0-2/timerwheel.lua/docs/*  docs/timerwheel
          cp -r timerwheel-0.2.0-2/timerwheel.lua/README.md  docs/timerwheel
          cp -r timerwheel-0.2.0-2/timerwheel.lua/LICENSE  docs/timerwheel

      - name: Build binaryheap
        run: |
          luarocks unpack binaryheap
          pushd .
          cd binaryheap-0.4-1/binaryheap.lua-version_0v4
          luarocks make binaryheap-0.4-1.rockspec
          popd
          mkdir docs/binaryheap
          cp -r binaryheap-0.4-1/binaryheap.lua-version_0v4/docs/*  docs/binaryheap
          cp -r binaryheap-0.4-1/binaryheap.lua-version_0v4/README.md  docs/binaryheap
          Invoke-WebRequest  https://raw.githubusercontent.com/Tieske/binaryheap.lua/master/LICENSE   -OutFile  docs/binaryheap/LICENSE

      - name: Build luafilesystem
        run: |
          luarocks unpack luafilesystem
          pushd .
          cd luafilesystem-1.8.0-1/luafilesystem
          luarocks make luafilesystem-1.8.0-1.rockspec
          popd
          mkdir docs/luafilesystem
          cp -r luafilesystem-1.8.0-1/luafilesystem/doc/us/*  docs/luafilesystem
          cp -r luafilesystem-1.8.0-1/luafilesystem/README.md  docs/luafilesystem
          cp -r luafilesystem-1.8.0-1/luafilesystem/LICENSE  docs/luafilesystem

      - name: Build copas
        run: |
          luarocks unpack rockspecs/copas-3.0.0-3.rockspec
          pushd .
          cd copas-3.0.0-3/copas
          luarocks make ../../rockspecs/copas-3.0.0-3.rockspec
          popd
          patch $env:LOCALAPPDATA"\LUAVM\versions\5.3\lua\copas.lua"  patches/copas.lua.patch
          mkdir docs/copas
          cp -r copas-3.0.0-3/copas/docs/* docs/copas 
          cp -r copas-3.0.0-3/copas/LICENSE docs/copas
          cp -r copas-3.0.0-3/copas/README.md docs/copas

      - name: Build coxpcall
        run: |
          luarocks install coxpcall
          
      - name: Build CopasTimer
        run: |
          luarocks install CopasTimer

      - name: Build lub
        run: |
          luarocks install lub

      - name: Build vstruct
        run: |
          luarocks unpack vstruct
          pushd .
          cd vstruct-2.1.1-1/vstruct
          luarocks make vstruct-2.1.1-1.rockspec
          popd
          mkdir docs/vstruct
          cp -r vstruct-2.1.1-1/vstruct/README.md docs/vstruct

      - name: Build lbase64
        run: |
          luarocks unpack lbase64
          pushd .
          cd lbase64-20120807-3/base64
          luarocks make lbase64-20120807-3.rockspec
          popd
          mkdir docs/lbase64
          cp -r lbase64-20120807-3/base64/README docs/lbase64

      - name: Build librs232
        run: |
          luarocks unpack rs232
          pushd .
          cd rs232-0.1.0-1/librs232-0.1.0
          luarocks make rs232-0.1.0-1.rockspec
          popd
          mkdir docs/librs232
          cp -r rs232-0.1.0-1/librs232-0.1.0/doc/* docs/librs232
          cp -r rs232-0.1.0-1/librs232-0.1.0/README.md docs/librs232

      - name: Build rings
        run: |
          luarocks unpack rings
          pushd .
          cd rings-1.3.0-1/rings-v_1_3_0
          luarocks make rings-1.3.0-1.rockspec
          popd
          mkdir docs/rings
          cp -r rings-1.3.0-1/rings-v_1_3_0/doc/* docs/rings
          cp -r rings-1.3.0-1/rings-v_1_3_0/README docs/rings

      - name: Build lua-curl
        run: |
          luarocks unpack lua-curl 
          pushd .
          cd lua-curl-0.3.13-1/Lua-cURLv3-0.3.13
          luarocks make lua-curl-0.3.13-1.rockspec  CC="CL -DCURL_STATICLIB" LD="link wldap32.lib zlibstatic.lib"
          popd
          mkdir docs/lua-curl
          cp -r lua-curl-0.3.13-1/Lua-cURLv3-0.3.13/doc/* docs/lua-curl
          cp -r lua-curl-0.3.13-1/Lua-cURLv3-0.3.13/README.md docs/lua-curl
          cp -r lua-curl-0.3.13-1/Lua-cURLv3-0.3.13/LICENSE docs/lua-curl

      - name: Build luafft
        run: |
          luarocks unpack rockspecs/luafft-1.2-1.rockspec
          pushd .
          cd luafft-1.2-1/luafft
          luarocks make ../../rockspecs/luafft-1.2-1.rockspec
          popd
          mkdir docs/luafft
          cp -r luafft-1.2-1/luafft/docs/* docs/luafft
          cp -r luafft-1.2-1/luafft/README.md docs/luafft

      - name: Build luatz
        run: |
          luarocks unpack luatz
          pushd .
          cd luatz-0.4-1/luatz-0.4
          luarocks make luatz-0.4-1.rockspec
          popd
          mkdir docs/luatz
          cp -r luatz-0.4-1/luatz-0.4/doc/* docs/luatz
          cp -r luatz-0.4-1/luatz-0.4/README.md docs/luatz

      - name: Build middleclass
        run: |
          luarocks unpack middleclass
          pushd .
          cd middleclass-4.1.1-0/middleclass-4.1.1
          luarocks make middleclass-4.1.1-0.rockspec
          popd
          mkdir docs/middleclass
          cp -r middleclass-4.1.1-0/middleclass-4.1.1/MIT-LICENSE.txt docs/middleclass
          cp -r middleclass-4.1.1-0/middleclass-4.1.1/README.md docs/middleclass

      - name: Build lustache
        run: |
          luarocks unpack lustache
          pushd .
          cd lustache-1.3.1-0/lustache-1.3.1-0
          luarocks make lustache-1.3.1-0.rockspec
          popd
          mkdir docs/lustache
          cp -r lustache-1.3.1-0/lustache-1.3.1-0/LICENSE docs/lustache
          cp -r lustache-1.3.1-0/lustache-1.3.1-0/README.md docs/lustache

      - name: Build moses
        run: |
          luarocks unpack moses
          pushd .
          cd moses-2.1.0-1/Moses-Moses-2.1.0-1
          luarocks make moses-2.1.0-1.rockspec
          popd
          mkdir docs/moses
          cp -r moses-2.1.0-1/Moses-Moses-2.1.0-1/doc/* docs/moses
          cp -r moses-2.1.0-1/Moses-Moses-2.1.0-1/README.md docs/moses
          cp -r moses-2.1.0-1/Moses-Moses-2.1.0-1/LICENSE docs/moses

      - name: Build luafun
        run: |
          luarocks unpack rockspecs/fun-0.1.3-1.rockspec
          pushd .
          cd fun-0.1.3-1/luafun
          luarocks make ../../rockspecs/fun-0.1.3-1.rockspec
          popd
          mkdir docs/fun
          cp -r fun-0.1.3-1/luafun/doc/* docs/fun
          cp -r fun-0.1.3-1/luafun/README.md docs/fun

      - name: Build MD5
        run: |
          luarocks unpack MD5
          pushd .
          cd md5-1.3-1/md5-1.3
          luarocks make md5-1.3-1.rockspec
          popd
          mkdir docs/MD5
          cp -r md5-1.3-1/md5-1.3/doc/* docs/MD5
          cp -r md5-1.3-1/md5-1.3/README.md docs/MD5

      - name: Build xavante
        run: |
          luarocks unpack xavante
          pushd .
          cd xavante-2.4.0-1/xavante-2.4.0
          luarocks make xavante-2.4.0-1.rockspec
          popd
          mkdir docs/xavante
          cp -r xavante-2.4.0-1/xavante-2.4.0/doc/* docs/xavante
          cp -r xavante-2.4.0-1/xavante-2.4.0/README.md docs/xavante

      - name: Build lyaml
        run: |
          luarocks unpack rockspecs/lyaml-6.1.3-2.rockspec
          pushd .
          cd lyaml-6.1.3-2/lyaml-6.1.3
          luarocks make ../../rockspecs/lyaml-6.1.3-2.rockspec
          popd
          mkdir docs/lyaml
          cp -r lyaml-6.1.3-2/lyaml-6.1.3/doc/* docs/lyaml
          cp -r lyaml-6.1.3-2/lyaml-6.1.3/README.md docs/lyaml
          cp -r lyaml-6.1.3-2/lyaml-6.1.3/LICENSE docs/lyaml

      - name: Build lua-protobuf
        run: |
          luarocks unpack rockspecs/lua-protobuf-0.3.4-1.rockspec
          pushd .
          cd lua-protobuf-0.3.4-1/lua-protobuf
          luarocks make ../../rockspecs/lua-protobuf-0.3.4-1.rockspec
          popd
          mkdir docs/lua-protobuf
          cp -r lua-protobuf-0.3.4-1/lua-protobuf/LICENSE docs/lua-protobuf
          cp -r lua-protobuf-0.3.4-1/lua-protobuf/README.md docs/lua-protobuf

      - name: Build luasql-mysql
        run: |
          luarocks unpack rockspecs\luasql-mysql-2.6.0-1.rockspec
          patch luasql-mysql-2.6.0-1/luasql/src/luasql.h  patches/luasql-mysql.patch --binary
          pushd .
          cd luasql-mysql-2.6.0-1/luasql
          luarocks make ../../rockspecs\luasql-mysql-2.6.0-1.rockspec
          popd
          mkdir docs/luasql-mysql
          cp -r luasql-mysql-2.6.0-1/luasql/doc/* docs/luasql-mysql
          cp -r luasql-mysql-2.6.0-1/luasql/README docs/luasql-mysql


      - name: Build luasql-firebird
        run: |
          luarocks unpack rockspecs/luasql-firebird-2.6.0-1.rockspec
          pushd .
          cd luasql-firebird-2.6.0-1/luasql
          luarocks make ../../rockspecs/luasql-firebird-2.6.0-1.rockspec
          popd
          mkdir docs/luasql-firebird
          cp -r luasql-firebird-2.6.0-1/luasql/doc/* docs/luasql-firebird
          cp -r luasql-firebird-2.6.0-1/luasql/README docs/luasql-firebird

      - name: Build luasql-postgres
        run: |
          luarocks unpack rockspecs/luasql-postgres-2.6.0-1.rockspec
          pushd .
          cd luasql-postgres-2.6.0-1/luasql
          luarocks make ../../rockspecs/luasql-postgres-2.6.0-1.rockspec
          popd
          mkdir docs/luasql-postgres
          cp -r luasql-postgres-2.6.0-1/luasql/doc/* docs/luasql-postgres
          cp -r luasql-postgres-2.6.0-1/luasql/README docs/luasql-postgres

      - name: Build luasql-sqlite3
        run: |
          luarocks unpack rockspecs/luasql-sqlite3-2.6.0-1.rockspec
          pushd .
          cd luasql-sqlite3-2.6.0-1/luasql
          luarocks make ../../rockspecs/luasql-sqlite3-2.6.0-1.rockspec
          popd
          mkdir docs/luasql-sqlite3
          cp -r luasql-sqlite3-2.6.0-1/luasql/doc/* docs/luasql-sqlite3
          cp -r luasql-sqlite3-2.6.0-1/luasql/README docs/luasql-sqlite3

      - name: Build luasql-odbc
        run: |
          luarocks unpack rockspecs\luasql-odbc-2.6.0-1.rockspec
          pushd .
          cd luasql-odbc-2.6.0-1/luasql
          luarocks make ../../rockspecs/luasql-odbc-2.6.0-1.rockspec
          popd
          mkdir docs/luasql-odbc
          cp -r luasql-odbc-2.6.0-1/luasql/doc/* docs/luasql-odbc
          cp -r luasql-odbc-2.6.0-1/luasql/README docs/luasql-odbc

      - name: Build lrexlib-pcre
        run: |
          luarocks unpack lrexlib-pcre 
          pushd .
          cd lrexlib-pcre-2.9.1-1/lrexlib
          luarocks make lrexlib-pcre-2.9.1-1.rockspec CC="CL -DPCRE_STATIC"
          popd
          mkdir docs/lrexlib-pcre
          cp -r lrexlib-pcre-2.9.1-1/lrexlib/doc/* docs/lrexlib-pcre
          cp -r lrexlib-pcre-2.9.1-1/lrexlib/README.rst docs/lrexlib-pcre
          cp -r lrexlib-pcre-2.9.1-1/lrexlib/LICENSE docs/lrexlib-pcre

      - name: Build stdlib
        run: |
          luarocks unpack stdlib
          pushd .
          cd stdlib-41.2.2-1/lua-stdlib-release-v41.2.2
          luarocks make stdlib-41.2.2-1.rockspec
          popd
          mkdir docs/stdlib
          cp -r stdlib-41.2.2-1/lua-stdlib-release-v41.2.2/doc/* docs/stdlib
          cp -r stdlib-41.2.2-1/lua-stdlib-release-v41.2.2/README docs/stdlib

      - name: Build luaexpat
        run: |
          luarocks unpack luaexpat
          pushd .
          cd luaexpat-1.4.1-1/luaexpat
          patch -p1 -i ..\..\patches\luaexpat.patch --binary
          luarocks make .\luaexpat-1.4.1-1.rockspec
          popd
          mkdir docs/luaexpat
          cp -r luaexpat-1.4.1-1/luaexpat/docs/* docs/luaexpat
          cp -r luaexpat-1.4.1-1/luaexpat/README.md docs/luaexpat
          cp -r luaexpat-1.4.1-1/luaexpat/LICENSE docs/luaexpat


      - name: Build luasec
        run: |
          luarocks unpack rockspecs/luasec-1.1.0-1.rockspec  
          pushd .
          cd luasec-1.1.0-1\luasec
          luarocks make ../../rockspecs/luasec-1.1.0-1.rockspec 
          popd
          mkdir docs/luasec
          cp -r luasec-1.1.0-1\luasec/samples/* docs/luasec
          cp -r luasec-1.1.0-1\luasec/README.md docs/luasec
          cp -r luasec-1.1.0-1\luasec/LICENSE docs/luasec

      - name: Build Lua-Zip
        run: |
          luarocks unpack rockspecs/lua-zip-0.2-0.rockspec 
          pushd .
          cd lua-zip-0.2-0/lua-zip
          luarocks make ../../rockspecs/lua-zip-0.2-0.rockspec 
          popd
          mkdir docs/lua-zip
          cp -r lua-zip-0.2-0/lua-zip/README.txt docs/lua-zip

      - name: Build Lpeg
        run: |
          luarocks install lpeg

      - name: Build Lua-cjson
        run: |
          git clone https://github.com/mpx/lua-cjson
          patch lua-cjson/lua_cjson.c  patches/lua-cjson.patch --binary
          pushd .
          cd lua-cjson
          luarocks make
          popd

      - name: Build Penlight
        run: |
          luarocks unpack penlight
          pushd .
          cd penlight-1.12.0-2/penlight
          luarocks make penlight-1.12.0-2.rockspec 
          popd
          mkdir docs/penlight
          cp -r penlight-1.12.0-2/penlight/docs/* docs/penlight
          cp -r penlight-1.12.0-2/penlight/README.md docs/penlight
          cp -r penlight-1.12.0-2/penlight/LICENSE.md docs/penlight

      - name: Build Lua-Zlib
        run: |
          luarocks unpack rockspecs/lua-zlib-1.2-2.rockspec 
          pushd .
          cd lua-zlib-1.2-2/lua-zlib
          luarocks make ../../rockspecs/lua-zlib-1.2-2.rockspec
          popd
          mkdir docs/lua-zlib
          cp -r lua-zlib-1.2-2/lua-zlib/README docs/lua-zlib

      - name: Build ZipWriter
        run: |
          luarocks unpack ZipWriter
          pushd .
          cd zipwriter-0.1.5-1/ZipWriter-0.1.5
          luarocks make zipwriter-0.1.5-1.rockspec
          popd
          mkdir docs/zipwriter
          cp -r zipwriter-0.1.5-1/ZipWriter-0.1.5/doc/* docs/zipwriter
          cp -r zipwriter-0.1.5-1/ZipWriter-0.1.5/README.md docs/zipwriter
          cp -r zipwriter-0.1.5-1/ZipWriter-0.1.5/LICENCE.txt docs/zipwriter
          "NoIndex: true`n" + (Get-Content docs/zipwriter/APPNOTE.TXT | Out-String) | Set-Content docs/zipwriter/APPNOTE.TXT

      - name: Build dkjson
        run: |
          luarocks unpack dkjson
          pushd .
          cd dkjson-2.6-1/dkjson-2.6
          luarocks make dkjson-2.6-1.rockspec 
          popd
          mkdir docs/dkjson
          cp -r dkjson-2.6-1/dkjson-2.6/README.txt docs/dkjson

      - name: Build lxsh
        run: |
          luarocks unpack lxsh
          pushd .
          cd lxsh-0.8.6-2/lxsh-0.8.6-1
          luarocks make lxsh-0.8.6-2.rockspec 
          popd
          mkdir docs/lxsh
          cp -r lxsh-0.8.6-2/lxsh-0.8.6-1/etc docs/lxsh
          cp -r lxsh-0.8.6-2/lxsh-0.8.6-1/README.md docs/lxsh
          cp -r lxsh-0.8.6-2/lxsh-0.8.6-1/examples docs/lxsh

      - name: Build serpent
        run: |
          luarocks unpack serpent
          pushd .
          cd serpent-0.30-2/serpent
          luarocks make  serpent-0.30-2.rockspec 
          popd
          mkdir docs/serpent
          cp -r serpent-0.30-2/serpent/README.md docs/serpent
          cp -r serpent-0.30-2/serpent/LICENSE docs/serpent



      - name: Collect files
        if: always()
        run: |
          mkdir archive
          mkdir archive\bin
          mkdir archive\lua
          mkdir archive\docs
          mkdir archive\tests
          # mkdir archive\luavm
          cp "batteries_header.lua" archive
          cp -r bin\* archive\bin
          cp -r lua\* archive\lua
          cp -r docs\* archive\docs
          cp -r  $env:LOCALAPPDATA"\LuaVM\versions\5.3\cmod\*" archive\bin
          cp -r   $env:LOCALAPPDATA"\LuaVM\versions\5.3\lua\*" archive\lua
          cp -r  tests/* archive/tests
          # cp -r  $env:LOCALAPPDATA"\LuaVM\externals archive\luavm
          Remove-Item archive\lua\luarocks -Recurse

      - name: Upload windows artifacts
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: Mavriq-Lua-Batteries
          path: archive